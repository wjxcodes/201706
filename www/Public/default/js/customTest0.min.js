
$.CustomTestStore={url:'',requestMark:false,knowledge:0,chapter:0,grade:'',types:'',subjectID:Cookie.Get('SubjectId'),username:Cookie.Get('wln_user_USER'),act:'',host:'',isFormat:false,showDialog:function(elemnt,title,delay,msg,type,bt1,bt2){$.myDialog.normalMsgBox(elemnt,title,delay,msg,type,bt1,bt2);},init:function(act,data,ifImage){this.act=act;this.InitDivHeight();if(!ifImage){$.Editor.init(U($.CustomTestStore.url+'/upload?dir=customTest'));FormatTextManager.types=$('#types');FormatTextManager.init();$('#format').click(function(){$.CustomTestStore.isFormat=false;if(FormatTextManager.formatContent()){$.CustomTestStore.showDialog('msgdiv','错误提示',500,FormatTextManager.err,2);return false;}
$.CustomTestStore.isFormat=true;$.CustomTestStore.showDialog('msgdiv','提示',500,'试题格式化完成！请重新检查内容，确认无误后点击[保存]！',1);});$('#save').click(function(){if($.Editor.requestMark){$.CustomTestStore.showDialog('msgdiv','提示',500,'内容已提交，正在处理中，请稍候！',2);return false;}
var data=$.CustomTestStore.validate();if(data){$.Editor.requestMark=true;$.post(U($.CustomTestStore.url+'/save'),data,function(result){$.Editor.requestMark=false;if($.myCommon.backLogin(result)==false){return false;}
var msg=result['data'];$.CustomTestStore.showDialog('msgdiv','提示',500,msg,3,'继续添加','查看试题');$('.normal_yes').click(function(){window.location.href=U('Custom/CustomTestStore/add');});$('.normal_no').click(function(){window.location.href=U('Custom/CustomTestStore/index');});});}
return false;});}
if(this.act=='add'){if(!ifImage){$.Editor.container=$('.editContainersTest');$.Editor.createContent();$.Editor.container=$('.editContainersAnswer');$.Editor.createSolution('',{'allowEmptyValue':true});$.Editor.container=$('.editContainersAnalytic');$.Editor.createAnalyze();}}else if(this.act=='edit'||this.act=='originality'){if(this.act=='originality'){this.act='add';}
this.editing(data);}
$('.toggleAttributes').click(function(){var that=$(this);$(this).parents('tr').nextAll('tr').toggle();if(that.html()=='隐藏'){that.html('展开');}else{that.html('隐藏');}});this.setBasicData();this.showTip('您当前正在编辑协同命制试题！');},showTestDemo:function(){$.CustomTestStore.showDialog('msgdiv','格式化例子',600,'<img src="/Public/default/image/custom_test_desc.png">',4);},showTip:function(message){if(Cookie.Get('user_ORIGINALITY')){var tip='<div>'+'<span style="color: #333333" >'+(message?message:'您当前正在编辑协同命制试题！')+'</span>'+'<a id="goIndexOriginality" style="text-decoration: underline;cursor: pointer">返回协同命制平台</a> '+'<a id="quitOriginality" style="color: #ff0000;text-decoration: underline;cursor: pointer">退出编辑</a>'+'</div>';$(tip).Tips({'delay':1000*7200});}
$(document).on('click','#goIndexOriginality',function(){top.window.location.href=U('Yc/Originality/originality?SubjectID='+Cookie.Get('SubjectId'));Cookie.Del('user_ORIGINALITY');});$(document).on('click','#quitOriginality',function(){window.location.href=U('Custom/CustomTestStore/index');Cookie.Del('user_ORIGINALITY');});},editing:function(data){var basic=data['basic'];if(basic['SubjectID']!=$.CustomTestStore.subjectID){alert('所编辑的试题与当前学科不符！');window.location.href=$.CustomTestStore.url;return false;}
$.CustomTestStore.types=basic['TypesID'];$.CustomTestStore.grade=basic['GradeID'];$.CustomTestStore.setTestNum(basic['TestNum']);$('.difficulty input').each(function(){if($(this).val()==basic['Diff']){$(this).attr('checked',true);}});$('#source').val(basic['Source']);$('#remark').val(basic['Remark']);if($.Editor){$.Editor.container=$('.editContainersTest');$.Editor.createContent(basic['Test']);$.Editor.container=$('.editContainersAnswer');$.Editor.createSolution(basic['Answer'],{'allowEmptyValue':true});$.Editor.container=$('.editContainersAnalytic');$.Editor.createAnalyze(basic['Analytic']);}
for(var val in data['knowledge']){if(!data['knowledge'][val]['KlID']){continue;}
var container=$('.knowledge-select-change-container').find('.inputs');var knowledge=data['knowledge'][val];container.append($('<div></div>').SelectText({_text:knowledge['KlName'],val:knowledge['KlID'],_name:'KlID'}));}
for(var val in data['chapter']){if(!data['chapter'][val]['ChapterID']){continue;}
var container=$('.chapter-select-change-container').find('.inputs');var chatper=data['chapter'][val];container.append($('<div></div>').SelectText({_text:chatper['ChapterName'],val:chatper['ChapterID'],_name:'ChapterID'}));}},InitDivHeight:function(){var height=$(window).height()-50;$("#divbox").css({'height':height-5,'overflow-y':'auto','overflow-x':'hidden'});},setBasicData:function(){var params={};if(this.subjectID){$('#types').html('<option value="">加载中请稍候...</option>');$('#knowledge').html('<option value="">加载中请稍候...</option>');$('#special').html('<option value="">加载中请稍候...</option>');$('#chapter').html('<option value="">加载中请稍候...</option>');params['subjectID']=this.subjectID;params['list']=['knowledge','chapter','special','types','grade'];params['style']='getMoreData';params=this.formatParams(params);$.post(U($.CustomTestStore.url+'/getData'),params,function(result){if($.myCommon.backLogin(result)==false){return false;};var datas=result['data'];$('#types').html('<option value="">请选择题型</option>'+$.CustomTestStore.addData(datas['types'],{val:'TypesID',text:'TypesName',isSelected:true,selectedById:$.CustomTestStore.types,attributes:{testnum:1,TypesStyle:'%s',IfChooseType:'%s'}}));$('#grade').html('<option value="">请选择年级</option>'+$.CustomTestStore.addData(datas['grade'],{val:'GradeID',text:'GradeName',isSelected:true,selectedById:$.CustomTestStore.grade}));$('#knowledge').html('<option value="">请选择主干知识点</option>'+$.CustomTestStore.addData(datas['knowledge'],{val:'KlID',text:'KlName'}));$('#chapter').html('<option value="">请选章节，避免超纲</option>'+$.CustomTestStore.addData(datas['chapter'],{val:'ChapterID',text:'ChapterName'}));},'json');}},formatParams:function(params){var param=[];for(var p in params){var str='';if(p==='list'){str='list='+params[p].join(',');}else{str=p+'='+params[p];}
param.push(str);}
return param.join('&');},addData:function(data,params){if(!data||typeof(data[0])=='undefined')
return false;params=$.extend({isSelected:false,selectedById:0,frontChar:'',val:false,text:false,attributes:{}},params);if(params.val===false||params.text===false){return false;}
var string='';for(var i=0;i<data.length;i++){var elements=data[i];var val=elements[params['val']];var text=elements[params['text']];var attributes={};for(var attr in params['attributes']){attributes[attr]=params['attributes'][attr];if(elements[attr]&&attributes[attr]=='%s'){attributes[attr]=elements[attr];}}
string+=this.getOption(params['frontChar']+val,text,(params.isSelected&&params.selectedById==val),attributes);}
return string;},getOption:function(val,text,isSelected,attribute,className){var str='<option value="'+val+'"';if(attribute){for(var attr in attribute){str+=' '+attr+'='+attribute[attr];}}
if(className){str+=' class="'+className+'"';}
if(isSelected){str+=' selected="selected"';}
return str+=('>'+text+'</option>');},setTestNum:function(num){},validate:function(){var data={};data['act']=this.act;data['verifyCode']=$('#verifyCode').val();data['TTID']=$('#ttid').val();data['TestID']=$('#testid').val();if(!$.CustomTestStore.username){$.CustomTestStore.showDialog('msgdiv','错误提示',500,'用户名不能为空',2);return false;}
if(!$.CustomTestStore.subjectID){$.CustomTestStore.subjectID=0;}
data['SubjectID']=$.CustomTestStore.subjectID;var grade=$('#grade').val();if(!grade){grade=0;}
data['GradeID']=grade;var source=$('#source').val();if(!source){source='';}
data['Source']=source;var types=$('#types').val();if(!types){types=parent.Types[$.CustomTestStore.subjectID][0]['TypesID'];}
data['TypesID']=types;var diff=$("input[name='diff']:checked").val();if(!diff){diff=0.801;}
data['Diff']=diff;if(!this.isFormat){FormatTextManager.isForamt=false;FormatTextManager.formatContent();}
var errors=[];for(var editor in $.Editor.instance){editor=$.Editor.instance[editor];var allowEmptyValue=editor.getOpt('allowEmptyValue');var content=editor.getContent().replace(/\r\n|\r|\n/g,'');if(!allowEmptyValue&&content==''){errors.push({info:editor.getOpt('title'),'editor':editor});}else{var name=editor.getOpt('textarea');data[name]=content;}}
if(errors.length>0){var error=[];for(var i=0;i<errors.length;i++){error.push(errors[i]['info']+'不能为空\r\n');}
$.CustomTestStore.showDialog('msgdiv','错误提示',500,error.join('，'),2);errors[0]['editor'].focus();return false;}
data['attributes']=FormatTextManager.getTopic();data['KlID']=[];var knowledge=$(".KlID_inputs");knowledge.each(function(){data['KlID'].push($(this).val());});data['Remark']=$('#remark').val();if(data['KlID'].length==0){}
data['ChapterID']=[];var chapter=$(".ChapterID_inputs");chapter.each(function(){data['ChapterID'].push($(this).val());});if(data['ChapterID'].length==0){}
return data;},debugLog:function(str){console.log(str);}};$.ImageTest={positionJson:[],picPath:'',picData:[],syncImage:function(no){var self=this;var post=function(no){$.post(U('Custom/CustomTestStore/webImagePoll'+'?n='+no+'&times='+Math.random()),function(e){if(e.status==1){$('.submitBtn').show();self.picData.push(e.data);self.addImgList(e.data);var oldsrc=$('.qrCode').attr('src');var oldno=no;no=parseInt(no)+1;$('.qrCode').attr('src',oldsrc.replace(oldno,no));}
post(no);});};post(no);},getQrCode:function(username){var self=this;var no=(new Date()).getTime();$('.qrCode').attr('src',U('Custom/CustomTestStore/qrCode')+'?n='+no+'&u='+username).show();setTimeout(function(){self.syncImage(no);},5000);},avatarUpload:function(){var self=this;var key=$('#key').val();var username=$('#username').val();var fileUpload=$('#fileUpload');fileUpload.uploadify({'buttonText':'上传图片','auto':true,'removeCompleted':false,'swf':'/Public/plugin/uploadify/uploadify.swf','uploader':U('Custom/CustomTestStore/avatarUpload?username='+username+'&key='+key),'method':'post','multi':false,'fileTypeDesc':'请上传.jpg;*.png;*.gif;类型文件','fileTypeExts':'*.gif; *.jpg; *.png','fileSizeLimit':'5120','onSelectError':function(file,errorCode,errorMsg){switch(errorCode){case-110:alert('请上传小于'+fileUpload.uploadify('settings','fileSizeLimit')+"k的图片！");break;}},'onUploadSuccess':function(file,data,response){data=eval('('+data+')');if(data.data.error){alert(data.data.error);return false;}else{$('.submitBtn').show();self.picData.push(data.data);self.addImgList(data.data);}}});},imageCutting:function(data,num){var e=data[num];var self=this;var originW=e.width;var originH=e.height;var frameW=800;var frameH=Math.round(frameW*originH/originW);if(originW<originH){frameH=400;frameW=Math.round(frameH*originW/originH);}
var rangeX=4;var rangeY=3;var originImg=$('#originImg'+num);self.picPath=e.picPath;$('#originBox'+num).height(frameH).width(frameW).show();originImg.attr('src',e.picPath).height(frameH).width(frameW);originImg.imgAreaSelect({handles:true,fadeSpeed:300,x1:0,y1:0,x2:280,y2:210,parent:$('#divbox'),onInit:function(){},onSelectChange:function(img,selection){rangeX=selection.width/frameW;rangeY=selection.height/frameH;},onSelectEnd:function(img,selection){var newX=selection.x1;var newY=selection.y1;self.positionJson[num]=[];self.positionJson[num]['x1']=Math.round(originW*newX/frameW);self.positionJson[num]['y1']=Math.round(originH*newY/frameH);self.positionJson[num]['width']=Math.round(rangeX*originW);self.positionJson[num]['height']=Math.round(rangeY*originH);}});},addImgList:function(data){var self=this;var length=$('.imgTest').length;var originH=self.picData[length]['height'];var originW=self.picData[length]['width'];var frameW=300;var frameH=Math.round(frameW*originH/originW);$('#fileUpload').uploadify('cancel','SWFUpload_0_'+length);var imgTestHtml='<li class="clearfix imgTest" id="imgTest'+length+'">'+'        <div class="cut-box" id="originBox'+length+'" style="display: none;">'+'            <img src="" class="preview" id="originImg'+length+'">'+'        </div>'+'        <div class="imgContent img-area left">'+'            <div class="nor-btn img-btn imgCut" id="imgBtn'+length+'" num="'+length+'">裁剪</div>'+'            <img height="200" width="260"  src="'+data.picPath+'" alt="已上传图片" id="prevImg"/>'+'        </div>'+'        <div class="img-intro">'+'            <div class="textarea-desc">图片描述：</div>'+'            <div class="textarea-wrap">'+'                <textarea name="testText" class="testText"></textarea>'+'            </div>'+'        </div>'+'        <a class="del-btn iconfont" href="javascript:;" title="删除" num="'+length+'">&#xe606;</a>'+'</li>';$('#imgTestList').append(imgTestHtml);},avatarSave:function(num){var self=this;var data=self.positionJson[num];var width=data.width;var height=data.height;var x1=data.x1;var y1=data.y1;var thisPicPath=self.picData[num].picPath;$.post(U('Custom/CustomTestStore/imgCutSave'),{picPath:thisPicPath,width:width,height:height,x1:x1,y1:y1},function(e){if($.myCommon.backLogin(e)==false){return false;}
if(e.status==1){$('#originImg'+num).imgAreaSelect({hide:true});$('#originBox'+num).hide();$('#imgTest'+num).find('.imgContetn').html('');var time=new Date().getTime();$('#imgTest'+num).find('#prevImg').attr('src',e.data.picPath+'?'+time);self.picData[num]=e.data;self.picData[num]['picPath']=e.data.picPath+'?'+time;}else{alert(e.data);}});},getTestAttr:function(){var data={};data['GradeID']=$('#grade').val();data['TypesID']=$('#types').val();data['Diff']=$("input[name='diff']:checked").val();data['Source']=$('#source').val();data['KlID']=[];$('.KlID_inputs').each(function(){data['KlID'].push($(this).val());});data['ChapterID']=[];$('.ChapterID_inputs').each(function(){data['ChapterID'].push($(this).val());});data['Remark']=$('#remark').val();return data;},bindImg:function(){var self=this;$(document).on('click','.imgCut',function(){var len=$('.saveImgCut').length;if(len>0){alert('请先保存之前裁切的图片！');return false;}
var num=$(this).attr('num');self.imageCutting(self.picData,num);$('#imgBtn'+num).removeClass('imgCut');$('#imgBtn'+num).addClass('saveImgCut');$('#imgBtn'+num).html('保存');});$(document).on('click','.saveImgCut',function(){var num=$(this).attr('num');self.avatarSave(num);$('#imgBtn'+num).removeClass('saveImgCut');$('#imgBtn'+num).addClass('imgCut');$('#imgBtn'+num).html('裁切');});$('#saveImgTest').on('click',function(){var data=[];$('.imgTest').each(function(){var picPath=$(this).find('#prevImg').attr('src');var testText=$(this).find('.testText').val();var test={'picPath':picPath,'testText':testText};data.push(test);});if(data.length==0){$.myDialog.normalMsgBox('msgdiv','提示',500,'<div>请先上传图片编辑！</div>',1);return false;}
$.post(U('Custom/CustomTestStore/imgTestSave'),{'data':data,'attr':self.getTestAttr()},function(e){if(e.status==1){if($.myCommon.backLogin(e)==false){return false;}
var msg=e['data'];$.CustomTestStore.showDialog('msgdiv','提示',500,msg,3,'继续添加','查看试题');$('.normal_yes').click(function(){window.location.href=U('Custom/CustomTestStore/photograph');});$('.normal_no').click(function(){window.location.href=U('Custom/CustomTestStore/index');});}else{var alertHtml='<div>'+e.data+' 请刷新本页面后重试！</div>';$.myDialog.normalMsgBox('msgdiv','提示',500,alertHtml,1);}})});$(document).on('click','.del-btn',function(){var num=$(this).attr('num');$('#originImg'+num).imgAreaSelect({hide:true});$('#imgTest'+num).remove();var len=$('.imgTest').length;if(len<1){$('.submitBtn').hide();}});},init:function(username){this.getQrCode(username);this.avatarUpload();this.bindImg();}};$.customTestStoreTestAdd={init:function(data,originality,url,ifImage,act){if(url.indexOf('/')===0){url=url.substring(1);}
this.pageInit(data,originality,url,ifImage,act);},pageInit:function(data,originality,url,ifImage,act){$.CustomTestStore.url=url;if(!originality['ttID']&&'add'==act){$.CustomTestStore.init('add',data,ifImage);}else{if(originality['ttID']){$('#ttid').val(originality['ttID']);data.basic={};data.basic.TypesID=originality['typeID'];data.basic.SubjectID=Cookie.Get('SubjectId');data.basic.Diff=originality['diff'];var params={'ID':originality['klID'],'style':'knowledgeList','return':1};if(originality['klID']){$.post(U('Custom/CustomTestStore/getData'),params,function(result){data.knowledge=result['data'];$.CustomTestStore.init('originality',data,ifImage);});}}else{$.CustomTestStore.init('edit',data,ifImage);}}
$('.knowledge-select-change-container').SelectChangeHandle({classname:'.selection',subjectid:$.CustomTestStore.subjectID,url:U(url+'/getData'),kv:'KlID',vv:'KlName',identify:'knowledge'});$('.chapter-select-change-container').SelectChangeHandle({classname:'.selection',subjectid:$.CustomTestStore.subjectID,url:U(url+'/getData'),kv:'ChapterID',vv:'ChapterName',identify:'chapter',allowEmptyVal:true});}};$.fn.SelectChangeHandle=function(option){return $(this).each(function(){var opts=$.extend({loadBtn:'.append',classname:'select',loadArea:'.inputs',subjectid:false,allowEmptyVal:false,kv:'',vv:'',identify:'',url:'',callback:function(result,currentSel,selects){if($.myCommon.backLogin(result)==false){return false;};var datas=result['data'];finished=true;if(!datas||typeof(datas[0])=='undefined'){return false;}
currentSel.nextAll(opts.classname).remove();var newer=$('<select></select>');newer.attr('class',currentSel.attr('class'));newer.append($.CustomTestStore.getOption('','请选择'));for(var i=0;i<datas.length;i++){var data=datas[i];newer.append($.CustomTestStore.getOption(data[opts.kv],data[opts.vv]));}
currentSel.after(newer);}},option);if(!opts.subjectid){alert('请选择学科');return false;}
var that=$(this);that.find(opts.classname).live('change',function(){var _select=$(this);if(_select.val()==''){$(this).nextAll(opts.classname).remove();return false;}
var data={};data['subjectID']=opts.subjectid;data['pID']=_select.val();data['style']=opts.identify;sendRequest(_select,data);});that.find(opts.loadBtn).click(function(){var _this=$(this);var text=[];var vals=[];var selects=getSelects();var size=selects.length;for(var i=0;i<size;i++){var _select=$(selects[i]);if(_select.val()==''){if(!opts.allowEmptyVal||i<2){var thiscontent=_this.parents('td').last().prev().html();if(typeof(thiscontent)!='undefined'&&thiscontent!='')thiscontent=thiscontent.replace('：','');else thiscontent='';if(thiscontent!='')alert('请选择'+thiscontent+'内容。');else alert('请正确选择内容');_select.focus();return false;}}else{var selected=_select.find('option:checked');text.push(selected.text());vals.push(selected.val());}}
if(text.length==0){return false;}
vals=vals[vals.length-1];if(inputIsExist(vals)){var div=$('<div></div>');that.find(opts.loadArea).append(div.SelectText({_text:text.join('&nbsp;&gt;&nbsp;'),_name:opts.kv,val:vals}));}});function inputIsExist(val){var inputs=$(opts.loadArea).find('input');for(var i=0;i<inputs.length;i++){if(val==inputs[i].value){return false;}}
return true;}
function sendRequest(currentSel,data){data['r']=Math.random();$.post(opts.url,data,function(result){opts.callback(result,currentSel,getSelects());});}
function getSelects(){return that.find(opts.classname);}});}
$.fn.SelectText=function(opts){opts=$.extend({loadArea:'.inputs',delBtn:'.input-del',_text:'',_name:'',val:''},opts);return $(this).each(function(){var that=$(this);that.append($(getText()));that.find(opts.delBtn).click(function(){that.remove();});});function getText(){if(/^(>>)|(.*?)|(>>)$/.test(opts._text)){opts._text=opts._text.replace(/^(>>)(.*?)(>>){0,}$/,'$2');opts._text=opts._text.replace(/>>/ig,'&nbsp;&gt;&nbsp;');}
return"<a href='#' class='input-del' title='移除'>x</a><span>"+opts._text+"</span><input type='hidden' class='"+opts._name+"_inputs' value='"+opts.val+"'>";}}