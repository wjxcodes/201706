{#// 加载头部公共文件 #}
{#include file="Public/header" /#}
<!--基础文件，分别是jQuery基库和拖拽UI插件-->
<script src="__PUBLIC__/plugin/jquery.ui.draggable.js" type="text/javascript"></script>

<!-- 对话框核心JS文件和对应的CSS文件-->
<script src="__PUBLIC__/plugin/alert/jquery.alerts.js" type="text/javascript"></script>
<link href="__PUBLIC__/plugin/alert/jquery.alerts.css" rel="stylesheet" type="text/css" media="screen" />
<style>
*{ margin:0px; padding:0px;overflow:hidden;}
.main_right{ width:360px; background:#ececec; border-left:#cfcfcf solid 1px;/* min-height:600px;height:auto!important; _height:600px;    */padding:1px 0px 20px 0px; float:right; overflow-y:scroll;}
.main_right_title{ font-size:16px; font-weight:bold; color:#000; margin-bottom:14px; width:100%; border-bottom:#bebebe solid 1px; padding-bottom:10px; overflow:auto; padding-top:15px}
.main_right_title span{ float:left; height:16px; width:5px; background:#6292c1; margin-right:7px; margin-top:2px; margin-left:12px}
 .top_nr_box{
    position: absolute;
    width:100%;
    overflow: hidden;
} 
TABLE.list{width:350px; margin:0px auto; background:none}
TABLE.list td{ padding:2px 0px; line-height:24px; background:none}
.dfms_box{ float:right; font-weight:normal; font-size:14px; padding-right:12px}
.an_box{ background:none}
.an_box td{ padding-top:15px; background:none; padding-left:60px}
.fl{ float:left;}
.fr{ float:right}

.main_left{margin-right:360px;}
.lj_box{ padding:10px; height:30px;}
.styl_box{ overflow-y:scroll;}
.styl_box table{ width:98%; margin:0px auto}
.styl_box table td{
    border: #CCC solid 1px;
    padding: 10px;
    line-height: 24px;
}
.styl_box table th{ background:#6292c1; color:#fff; line-height:40px; text-indent:15px;}
.bottom_nr_box{ position:absolute; bottom:0px; left:0px; width:100%; height:120px; background:#e0e0e0; border-top:#b5b5b5 solid 1px; z-index:1000;}
.bottom_nr_box .title{ background:none; border:none; border-bottom:#bdbdbd solid 1px; padding-bottom:10px;}
.bottom_nr_box .d_nr_box{overflow-x:scroll; width:100%;}
.bottom_nr_box .nr_box{ padding:15px 20px; height:24px;}
.bottom_nr_box .tit{float:left;display:block; font-weight:bold; margin-top:5px}

.d_nr_box a{float:left; display:block;border-bottom:none; border:#acacac solid 1px; padding:4px 10px; background:#FFF; -moz-border-radius: 10px;            /* Gecko browsers */
        -webkit-border-radius: 10px;     /* Webkit browsers */
        border-radius:10px; margin-left:5px; font-family:"宋体"; color:#666; text-decoration:none;font-weight:bold; }
.bottom_nr_box .this{ background:#d2e4f2; border:#4b7fb2 solid 1px; color:#174b73;}
.bottom_nr_box .del{ background:#aaa; border:#111 solid 1px; color:#888;}
.bottom_nr_box .yj{ background:#6292c1; border:#4b7fb2 solid 1px; color:#fff;}


.top_nr_box .delhang{padding:0px 5px;cursor:pointer;color:#f00;}
.top_nr_box .delhang:hover{background-color: red; color:#fff;}
.xt_title{
    white-space: nowrap;
    margin:0px 5px;
}
#defChapterPanel{
    position:absolute;
    top:0px;
    left:0px;
    background-color: #fff;
    border-top:1px solid #ccc;
    border-left:1px solid #ccc;
    border-bottom:1px solid #ccc;
    padding:10px;
    display: none;
    z-index:1000;
    overflow: auto;
    width:350px;
}
#defChapterPanel p{
    margin-bottom:5px;
}
.addChapterBtn{
    border:1px solid #ccc;
    background-color: #ececec;
    cursor: pointer;
    padding:4px 6px;
    margin-bottom:5px;
    margin-right: 25px;
    font-size: 13px;
}
.addChapterBtn:hover{
    background-color: #fff;
    color:#999;
}
</style>
<link href="__PUBLIC__/teacher/css/style.css" rel="stylesheet" type="text/css" media="screen" />
<div id="wrap">
    <div class='top_nr_box'>
        <div class="main_right">
        <div class="main_right_title"><span></span>属性标注</div>
        <TABLE border="0" align="center" cellpadding="5" cellspacing="0" class="list" style="">
        <TR>
            <TD width="65" align="right" class="tRight" >知识点：</TD>
            <TD width="249" class="tLeft" ><SELECT id="knowledge" class="knowledge bLeft large" NAME="KlID">
                <option value="">请选主干知识点</option>
                </SELECT>
                </TD>
        </TR>
        <tr class='addButton'>
            <td width='314' align="right" colspan="2">
                <div class="impBtn" style="display:inline;padding:3px 0px;"><input id="addkl" name="addkl" class="add imgButton" type="button" value="添加"></div>
            </td>
        </tr>
        <TR>
            <TD align="right" class="tRight">章&nbsp;&nbsp;节：</TD>
            <TD class="tLeft" ><SELECT id="chapter" class="chapter bLeft large" NAME="ChapterID">
            <option value="">请选章节，避免超纲</option>
            </SELECT> 
            </TD>
        </TR>
        <tr class='addButton'>
            <td width='314' align="right" colspan="2">
                <div class="impBtn" style="display:inline;padding:3px 0px;"><input id="addcp" name="addcp" class="add imgButton" type="button" value="添加"/></div>&nbsp;&nbsp;<div class="impBtn" style="display:inline;padding:3px 0px;"><a id="adddcp" style="cursor:pointer;">系统提示</a></div>
            </td>
        </tr>
        <TR>
                <TD align="right" class="tRight">专&nbsp;&nbsp;题：</TD>
                <TD class="tLeft" ><SELECT id="special" class="large bLeft" NAME="SpecialID">
                <option value="">请选择</option>
                </SELECT></TD>
        </TR>



        <input name="xttimes" id="xttimes" value="{#$times#}" type="hidden"/>
        </TABLE>
        <div class="main_right_title"><span></span>试题打分<div class="dfms_box"><label style='color:red;'>
                    <INPUT TYPE="radio" id="kg" class="DfStyle bLeft" check='raido' warning="请选择打分模式" NAME="DfStyle" value="0" {#if condition="($edit['DfStyle'] eq '0') or ($edit['DfStyle'] eq '')"#}checked="checked"{#/if#}> 客观打分</label> <label><INPUT id="zg" TYPE="radio" class="DfStyle bLeft" NAME="DfStyle" value="1" {#eq name="edit.DfStyle" value="1"#}checked="checked"{#/eq#}> 主观打分</label></div></div>
        <table border="0" align="center" cellpadding="5" cellspacing="0" class="list zgdf" style="">
            <tr>
                <td width="65" align="right" class="tRight" >难度值：</td>
                <td width="249" class="tLeft" ><input type="text" value="{#$edit.Diff#}" name="Diff" id="Diff" style="width:80px" />
                    (0-1之间 最多4位小数)</td>
            </tr>
            <input name="xttimes3" id="xttimes3" value="{#$times#}" type="hidden"/>
        </table>
        {#if condition="mark_array"#}
        <table border="0" align="center" cellpadding="5" cellspacing="0" class="list kgdf" style="">
            {#if condition="$times>1"#}
                <tr>
                    <td colspan="2" align="center" width='359'>    
                        {#for start="1" end="$times+1"#}
                            <span id="xt{#$i#}" {#eq name="i" value="1"#} class="xtcurrent xt_title" {#else/#} class="xt xt_title"{#/eq#}>小题{#$i#}</span>
                        {#/for#}
                    </td>
                </tr>
            {#/if#}
            {#for start="1" end="$times+1" name="ii"#}
                {#volist name="mark_array" id="vo" key="j"#}
                <TR class="xt_con_{#$ii#} xt_con {#neq name="ii" value="1"#}none{#/neq#}">
                    <td align="right" class="tRight" style="width:120px;">
                        {#eq name="vo.Style" value="0"#}
                        <font color="red" title='红色为必选项'>{#$vo.MarkName#}：</font>
                        {#else/#}
                        {#$vo.MarkName#}：
                        {#/eq#}
                    </TD>
                    <td class="tLeft" ><SELECT id="xt_select_{#$ii#}_{#$j#}" class="mark large bLeft" NAME="Mark[]" style='width:229px;'>
                    <option value="">请选择</option>
                    {#volist name="vo.MarkListx" id="item"#}
                    <option value="{#$item[3]#}" {#volist name="edit.Markx.$ii" id="mk"#}{#if condition="$mk eq $item[3]"#}selected="selected"{#/if#}{#/volist#}>{#$item[1]#}</option>
                    {#/volist#}
                    </SELECT></TD>
                </TR>
                {#/volist#}
            {#/for#}
            </table>
        {#/if#}
        <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="an_box">
        <tr><td align="center" style='padding-bottom:20px;'>
            <INPUT TYPE="hidden" id="code" name="code" value="{#$securityCode#}">
            <INPUT TYPE="hidden" id="TestID" name="TestID" value="{#$edit.TestID#}">
            <div class="impBtn fLeft" style='margin-left:70px;'>
                <INPUT tag='form1' id="datasave" u='{#:U('Teacher/Test/save')#}' TYPE="button" value="保存" class="save imgButton mysubmit">
                <input type="hidden" class="next imgButton" value="下一题" style="width:85px"/>
            </div>
            <div class="impBtn fLeft m-l10">
                
            </div></td></tr>
        </table>
        </div>
        <div class="main_left">
        <div class="lj_box"><span class=" fl"><strong>当前位置：<a href='{#:U('Teacher/Task/checkwork', array('id'=>$wid))#}'>当前任务</a> &gt&gt </strong>试题标引【{#$tid#}】</span><span class="fr"><a href="javascript:history.go(-1);">返回上一页</a></span></div>
        <div class="styl_box">
        <table width="98%" border="0" align="center" cellpadding="0" cellspacing="0">
            <tr>
                <th colspan="2" align="left">试题预览：编号{#$edit.TestID#}</th>
            </tr>
            {#if condition="$errorInfo neq ''"#}
            <tr>
                <td width="90" align="center"><strong><font color='red'>意见</font></strong></td>
                <td width="89%">{#$errorInfo#}</td>
            </tr>
            {#/if#}
            <tr>
                <td width="90" align="center"><strong>题文</strong></td>
                <td width="89%">{#$edit.Test#}</td>
            </tr>
            <tr>
                <td align="center"><strong>答案</strong></td>
                <td>{#$edit.Answer#}</td>
            </tr>
            <tr>
                <td align="center"><strong>解析</strong></td>
                <td>{#$edit.Analytic#}</td>
            </tr>
            <tr>
                <td align="center"><strong>题型</strong></td>
                <td>{#$edit.TypesName#}</td>
            </tr>
            <tr>
                <td align="center"><strong>备注</strong></td>
                <td>{#$edit.Remark#}</td>
            </tr>
        </table>

        </div>
        </div>
    </div>
    <div class="bottom_nr_box">
        <div class="title">试卷编号及名称：[{#$doc.DocID#}] {#$doc.DocName#}&nbsp; <a href="{#:U('Teacher/Test/index', array('did'=>$did, 'wid'=>$wid))#}" class='lookAllTest' title='所有试题编辑完成后查看'>查看全部试题</a></div>
        <div class="d_nr_box">
            <div class="nr_box">
                <span class="tit">试题编号:</span>
                {#volist name="tids" id="node" #}
                    {#if condition="$edit['TestID'] eq $node['TestID']"#}
                        <a href="#" class='this'>{#$node.TestID#}</a>
                    {#elseif condition="$node['Duplicate'] neq '0'"/#}
                        <a href="#" class='del' title="重复试题无需标引">{#$node.TestID#}</a>
                    {#else/#}
                        <a href="{#:U('Teacher/Test/intro', array('did'=>$did, 'wid'=>$wid, 'id'=>$node['TestID']))#}" class='targetTest'>{#$node.TestID#}</a>
                    {#/if#}
                {#/volist#}
            </div>
        </div>
    </div>
</div>
<div id='defChapterPanel'></div>
<script src='__PUBLIC__/teacher/js/common1.js'></script>
<script>
    $(document).click(function(e){
        e = e || event;
        var target = e.srcElement || e.target;
        var parent = target;
        var mark = true;
        while(parent){
            if(parent.id == 'defChapterPanel' || parent.id == 'adddcp'){
                mark = false;
                break;
            }
            parent = parent.parentNode;
        }
        if(mark){
            $('#defChapterPanel').hide();
        }
    });
    $('#addChapter').live('click',function(){
        if($('#defChapterPanel input:checked').length == 0){
            alert('请选择章节！');
            return false;
        }
        var mark = 0;
        var last = $('.main_right .cp').last().parents('tr');
        if(last.length == 0){
            last = $('#addcp').parents('.addButton');
        }
        $('#defChapterPanel input').each(function(){
            var that = $(this);
            if(that.attr('checked')){
                var value = that.val();
                var name = that.siblings('label').html();
                var xx=inputcp.replace('#value#',value).replace('#str#',name);
                if(!exist('cp',value)){
                    mark++;
                    last.after(xx);
                } 
            }
        })
        $('#defChapterPanel').hide();
        if(mark > 0)
            alert('默认章节加载成功！');
    });

    //$(document).bind("contextmenu",function(){return false;});
    $(document).bind("selectstart",function(){return false;});
    resize();
    $(window).resize(function(){
        resize();
    });

    $('.targetTest').each(function(){
        $(this).click(function(){
            if(isSuccess){
                location.href=$(this).attr('href');
            }else{
                alert('请先编辑试题保存后在进行此操作！');
            }
            return false;
        });
    });
    var currentAuthor = $('.this');
    $('.d_nr_box').scrollLeft(currentAuthor.position().left/2);
    $('.next').click(function(){
        if(!isSuccess){
            alert('请先编辑试题保存后在进行此操作！');
            return false;
        }
        var nextid = '{#$nextid#}';
        if(nextid == -1){
            alert('所有试题已经编辑完成！下面进入试题列表。');
            location.href = U("Teacher/Test/index?did={#$did#}&wid={#$wid#}");
            return;
        }
        location.href = U("Teacher/Test/intro?did={#$did#}&wid={#$wid#}&id="+nextid);
        return false;
    });
    $('#zg').click(function(){
        $('.zgdf').show();
        $('.kgdf').hide();
    });
    $('#kg').click(function(){
        $('.zgdf').hide();
        $('.kgdf').show();
        changext(1);
    });
    {#if condition="$edit['DfStyle'] eq 1"#}
        $('.zgdf').show();
        $('.kgdf').hide();
    {#else/#}
        $('.zgdf').hide();
        $('.kgdf').show();
    {#/if#}
    var redirect = '{#$redirect#}';
    var s='{#$edit.SubjectID#}';
    var p='{#$edit.SpecialID#}';
    var k='{#$edit.KlID#}';
    var c='{#$edit.ChapterID#}';
    var input='<tr><td width="80" align="right" class="tRight" ></td><td width="249" class="tLeft" ><div><span class="delhang">x</span> #str#<input class="kl" name="kl[]" type="hidden" value="#value#"/></div></td></tr>';
    var inputcp='<tr><td width="80" align="right" class="tRight" ></td><td width="249" class="tLeft" ><div><span class="delhang">x</span> #str#<input class="cp" name="cp[]" type="hidden" value="#value#"/></div></td></tr>';
    setBasicData();
  
    $('.top_nr_box .delhang').live('click',function(){
        $(this).parents('tr').remove();
    });
    //修改框事件
    $('.knowledge').live('change',function(){
        var tt=$(this);
        tt.parents('tr').nextAll('.knowledgeTr').remove();
        if(tt.val()=='') return;
        var data = {
            'subject':s,
            'style':'knowledge',
            'pID' : tt.val().replace('t',''),
            'r' : Math.random()
        }
        $.post(U('Teacher/Public/getBasicData'),data,function(result){
            if(backLogin(result)=='error'){
                return false;
            };
            var data = result['data'];
            if(!data){
                return false;
            }
            var output='<option value="">请选择</option>';
            for(datan in data){
                if(data[datan]['Last']==1) output+='<option value="t'+data[datan]['KlID']+'">'+data[datan]['KlName']+'</option>';
                else output+='<option value="'+data[datan]['KlID']+'">'+data[datan]['KlName']+'</option>';
            }
            tt.parents('tr').after('<tr class="knowledgeTr"><td width="80" align="right" class="tRight" ></td><td width="249" class="tLeft" ><select class="large knowledge">'+output+'</select>');
        },'json');
    });
    //修改框事件
    $('.chapter').live('change',function(){
        var tt=$(this);
        tt.parents('tr').nextAll('.chapterTr').remove();
        if(tt.val()=='') return;
        var data = {
            'subject':s,
            'style':'chapter',
            'pID' : tt.val().replace('c',''),
            'r' : Math.random()
        }
        $.post(U('Teacher/Public/getBasicData'),data,function(result){
            if(backLogin(result)=='error'){
                return false;
            };
            var data = result['data'];
            if(!data){
                return false;
            }
            var output='<option value="">请选择</option>';
            for(datan in data){
                if(data[datan]['Last']==1) output+='<option value="c'+data[datan]['ChapterID']+'">'+data[datan]['ChapterName']+'</option>';
                else output+='<option value="'+data[datan]['ChapterID']+'">'+data[datan]['ChapterName']+'</option>';
            }
            tt.parents('tr').after('<tr class="chapterTr"><td width="80" align="right" class="tRight" ></td><td width="249" class="tLeft" ><select class="large chapter">'+output+'</select></td></tr>');
        },'json');
    });

    $('#addkl').live('click',function(){
        if($('#knowledge').val()==''){
            alert('请选择知识点');
            return false;
        }
        var lastKnowLedgeTr = $('.knowledgeTr').last();
        var kid = '' ,xx_s = '';
        if(lastKnowLedgeTr.length == 0){
            var knowledge = $('#knowledge');
            lastKnowLedgeTr = knowledge.parents('tr');
            xx_s = ' >> '+knowledge.find("option:selected").text();
            kid = knowledge.find("option:selected").val().replace('t','');
        }else{
            var lastValue = lastKnowLedgeTr.find('.knowledge').val();
            if(lastValue.indexOf('t')==-1){
                alert('请选择正确的知识点');
                return false;
            }
            kid=lastValue.replace('t','');
            xx_s="";
            $('.knowledge').each(function(){
                xx_s+=' >> '+$(this).find("option:selected").text();
            });
        }
        var xx=input.replace('#value#',kid).replace('#str#',xx_s.replace(/┉/g,'').replace('┝',''));
        if(!exist('kl',kid)){
            lastKnowLedgeTr.next('.addButton').after(xx);
        }else{
            alert('该知识点已经选过!');
            return false;
        }
        //$('#knowledge').val('');
        //$('.knowledgeTr').remove();
    });
    $('#addcp').live('click',function(){
        if($('#chapter').val()==''){
            alert('请选择章节');
            return false;
        }
        var lastChapterTr = $('.chapterTr').last();
        var lastValue = lastChapterTr.find('.chapter').val();
        if($('.chapterTr').eq(0).find('.chapter').val() == ''){
            alert('请选择正确的数据');
            return false;
        }
        var cid=lastValue.replace('c','');
        var tmp_position=0;
        if(!cid){
            tmp_position=1;
            cid=lastChapterTr.prev().find('.chapter').val().replace('c','');
        }
        var xx_s="";
        $('.chapter').each(function(i){
            var val = $(this).find("option:selected").val();
            if(!(tmp_position==1 && $('.chapter').length==(i+1)) && val != '')
                xx_s+=' >> '+$(this).find("option:selected").text();
        });
        var xx=inputcp.replace('#value#',cid).replace('#str#',xx_s.replace(/┉/g,'').replace('┝',''));
        if(!exist('cp',cid)){
            lastChapterTr.next('.addButton').after(xx);
        }else{
            alert('该章节已经选过!');
            return false;
        }
        //$('#chapter').val('');
        //$('.chapterTr').remove();
    });

    //载入默认章节
    $('#adddcp').live('click',function(){
        var defChapterPanel = $('#defChapterPanel');
        if(defChapterPanel.css('display').toLowerCase() != 'none'){
            return;
        }
        var result='';
        $('.kl').each(function(){
            result += $(this).val()+",";
        });
        if(result == ''){
            alert('请选择知识点！');
            return false;
        }
        loadData('系统提示加载中......');
        var kl=result.substring(0, result.length-1);
        var testid=$('#TestID').val();
        $.get(U('Teacher/Public/getchapter?kl='+kl+'&id='+testid+'&r='+Math.random()),function(result){
            if(backLogin(result)=='error'){
                defChapterPanel.hide();
                return false;
            };
            var data = result['data'];
            if(data && data.length > 0){
                loadDefChapter(data);
            }else{
                defChapterPanel.hide();
                alert('暂无对应章节！');
            }
        },'json');
    });
    var sdata=0;
    var x=0;
    var isSuccess = false;
    $('#datasave').live('click',function(){
        if(x){
            alert('正在提交请稍候.....');
            return false;
        }
        sdata=0;
        
        //主观客观打分
        if($('#kg').attr('checked')=='checked'){
            var fs=0;
            var tmp_arr=new Array();
            var xttimes=parseInt($(".mark").length)/parseInt($('#xttimes').val());
            $(".mark").each(function(i){
                if($(this).val()){
                    tmp_arr=$(this).val().split("|");
                    if(tmp_arr[1]>-1 && tmp_arr[1]<4) fs+=parseInt(tmp_arr[1]);
                }    
                if((i+1)%xttimes==0 && i!=0){
                    if(fs<4 || fs>12){
                        alert('请选择正确的打分数据');
                        sdata=1;
                        return false;
                    }
                    fs=0;
                }
            });
        }else{
            var xsdiff=$('#Diff').val();
            if(xsdiff<0 || xsdiff>=1){
                alert('请填入正确的难度值');
                $('#Diff').focus();
                return false;
            }
        }
        if(sdata==1){
            return false;
        }
        x=1;
        if(x){
            var testid=$('#TestID').val();
            
            var result='';
            $('.kl').each(function(){
                result += $(this).val()+",";
            });
            var kl=result.substring(0, result.length-1);
            
            
            result='';
            $('.cp').each(function(){
                    result += $(this).val()+",";
            });
            var cp=result.substring(0, result.length-1);
            
            var specialid=$('#special').val();
            
            result='';
            $('.mark').each(function(){
                    result += $(this).val()+",";
            });
            var mark=result.substring(0, result.length-1);
            
            result='';
            $('.DfStyle').each(function(){
                if($(this).attr('checked')=='checked'){
                    result = $(this).val();
                }
            });
            var dfstyle=result;
            
            var diff=$('#Diff').val();
            var code=$('#code').val();
            //提交数据
            $.ajax({
                 type: "POST",
                 cache: false,
                 url: U("Teacher/Test/save"),
                 data: "TestID="+testid+"&kl="+kl+"&cp="+cp+"&SpecialID="+specialid+"&Mark="+mark+"&DfStyle="+dfstyle+"&Diff="+diff+'&s='+code,
                 success: function(result){
                    if(backLogin(result)=='error'){
                        return false;
                    };
                    var msg = result['data'];
                     x=0;
                     if(msg == 'success'){
                        isSuccess = true;
                        if(redirect != ''){
                            if(window.confirm('保存成功，是否回到列表页？取消将继续编辑下一题。')){
                                window.location.href = redirect;
                            }else{
                                $('.next').trigger('click');
                            }
                            return false;
                        }
                        if(window.confirm('保存成功！是否进入下一题？')){
                            $('.next').trigger('click');
                        }
                     }else{
                        alert(msg);
                     }
                 },
                 error: function(XMLHttpRequest, textStatus, errorThrown){
                     x=0;
                     alert( "保存数据失败！请重试。" );
                 }
            });
        }
    });

    $('.xt_title').live('click',function(){
        var idx = $(this).attr('id').replace('xt','');
        changext(idx);
    });
    
    /*切换选项卡*/
    function changext(idx){
        $('.xt_con').hide();
        $('.xt_con').addClass('none');
        $('.xt_con_'+idx).removeClass('none');
        $('.xt_con_'+idx).show();
        $('.xt_title').removeClass('xtcurrent');
        $('.xt_title').removeClass('xt');
        $('.xt_title').addClass('xt');
        $('#xt'+idx).addClass('xtcurrent');
    }
    function exist(className,val){
        var b = false;
        $('.'+className).each(function(){
            if($(this).val() == val){
                b = true;
            }
        });
        return b;
    }

    function resize(){
        var _height = $(window).height()-120;
        var boxWidth = 0;
        $('.nr_box a').each(function(){
            boxWidth += $(this).outerWidth()+8;
        });
        var windowWidth = $(window).width();
        if(windowWidth > boxWidth){
            boxWidth = windowWidth-40;
        }else{
            boxWidth += 40;
        }
        $('.styl_box').height(_height-53);
        $('.main_right').height(_height-23);
        $('.nr_box').width(boxWidth);
        $('.top_nr_box').height(_height);
        $('#defChapterPanel').hide();
    }

    function loadDefChapter(data){
        var defChapterPanel = $('#defChapterPanel');
        var html = '';
        for(var i=0;i<data.length;i++){
            if(!exist('cp',data[i]['ChapterID'])){
                var xx=inputcp.replace('#value#',data[i]['ChapterID']).replace('#str#',data[i]['ChapterName']);
                html += '<p><input type="checkbox" id="cbx_'+data[i]['ChapterID']+'" value="'+data[i]['ChapterID']+'"><label for="cbx_'+data[i]['ChapterID']+'">'+data[i]['ChapterName']+'</label></p>';
            }
        }

        if('' == html){
            defChapterPanel.hide();
            if(data.length > 0){
                alert('指定知识点的默认章节已全部添加！');
            }
            return;
        }
        html += '<span class="addChapterBtn" id="addChapter">添加</span><font color="red" style="font-size:13px;">提示：仅供参考，请仔细核查超纲问题！</font>';
        loadData(html);
    }

    function loadData(html){
        var defChapterPanel = $('#defChapterPanel');
        var styl = $('.styl_box');
        var top = styl.position().top-3;
        defChapterPanel.css('height','auto').html(html);
        if(defChapterPanel.position().top+defChapterPanel.outerHeight() > styl.outerHeight()){
            defChapterPanel.height(styl.outerHeight()-16);
        }
        var main_right = $('.main_right');
        var position = main_right.offset();
        defChapterPanel.css({'left':(position.left-defChapterPanel.outerWidth()),'top':top});
        defChapterPanel.show();
    }
    function setBasicData(){
        var params = {};
        if(s){
            $('#knowledge').html('<option value="">加载中......</option>');
            $('#special').html('<option value="">加载中......</option>');
            $('#chapter').html('<option value="">加载中......</option>');
            params['subject'] = s;
            params['style'] = ['knowledge','chapter','special'];
            //params['pID'] = p;
            if(k!='0'){
                params['style'].push('knowledgeList');
                params['klid'] = k;
            }
            if(c!='0'){
                params['style'].push('chapterList');
                params['clid'] = c;
            }
            params = formatParams(params);
            $.post(U('Teacher/Public/getBasicData'),params,function(result){
                if(backLogin(result)=='error'){
                    return false;
                };
                var datas = result['data'];
                $('#knowledge').html('<option value="">请选择主干知识点</option>'+addData(datas['knowledge'],{val:'KlID',text:'KlName'}));
                
                $('#chapter').html('<option value="">请选章节，避免超纲</option>'+addData(datas['chapter'],{val:'ChapterID',text:'ChapterName'}));
                
                addStrips(datas['special']);
                var str = '';
                for(var i=0; i<nodes.length; i++){
                    str += nodes[i].getText();
                }
                $('#special').html('<option value="">请选择</option>'+str);
                $('#special').val(p);

                if(k!='0'){
                    var data = datas['knowledgeList'];
                    if(data){
                        for(var i=0;i<data.length;i++){
                            var xx=input.replace('#value#',data[i]['KlID']).replace('#str#',data[i]['KlName']);
                            if(!exist('kl',data[i]['KlID'])){
                                $('#knowledge').parents('tr').next('.addButton').after(xx);
                            }
                        }
                    }
                }
                if(c!='0'){
                    var data = datas['chapterList'];
                    if(data){
                        for(var i=0;i<data.length;i++){
                            var xx=inputcp.replace('#value#',data[i]['ChapterID']).replace('#str#',data[i]['ChapterName']);
                            if(!exist('cp',data[i]['ChapterID'])){
                                $('#chapter').parents('tr').next('.addButton').after(xx);
                            }
                        }
                    }
                }
            },'json');
        }
    }
    function formatParams(params){
        var param = [];
        for(var p in params){
            var str = '';
            if(p === 'style'){
                str = 'style='+params[p].join(',');
            }else{
                str = p+'='+params[p];
            }
            param.push(str);
        } 
        return param.join('&');
    }
</script>
{#// 加载尾部公共文件 #}
{#include file="Public/ends" /#}